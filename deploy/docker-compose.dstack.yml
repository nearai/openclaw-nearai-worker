services:
  dstack-ingress:
    image: dstacktee/dstack-ingress:20250929
    network_mode: host
    environment:
      - DOMAINS=*.${OPENCLAW_DOMAIN}
      - CERTBOT_EMAIL=${CERTBOT_EMAIL}
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock
      - /var/run/tappd.sock:/var/run/tappd.sock
      - cert-data:/etc/letsencrypt
      - nginx-dynamic:/data/nginx
    configs:
      - source: openclaw_nginx
        target: /etc/nginx/conf.d/openclaw.conf
    restart: unless-stopped

  compose-api:
    image: openclaw-compose-api:local
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/run/dstack.sock:/var/run/dstack.sock
      - management-data:/app/data
      - nginx-dynamic:/data/nginx
    environment:
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - OPENCLAW_DOMAIN=${OPENCLAW_DOMAIN}
      - OPENCLAW_IMAGE=${OPENCLAW_IMAGE}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - CLOUDFLARE_ZONE_ID=${CLOUDFLARE_ZONE_ID}
      - GATEWAY_DOMAIN=${GATEWAY_DOMAIN}
      - NGINX_MAP_PATH=/data/nginx/backends.map
      - INGRESS_CONTAINER_NAME=dstack-ingress
      - COMPOSE_FILE=/app/docker-compose.worker.yml
      - LISTEN_ADDR=0.0.0.0:8080
    restart: unless-stopped
    depends_on:
      - dstack-ingress

configs:
  openclaw_nginx:
    content: |
      map $$host $$openclaw_backend {
          include /data/nginx/backends.map;
      }

      server {
          listen 443 ssl;
          server_name *.${OPENCLAW_DOMAIN};

          ssl_certificate /etc/letsencrypt/live/${OPENCLAW_DOMAIN}/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/${OPENCLAW_DOMAIN}/privkey.pem;

          location / {
              proxy_pass $$openclaw_backend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $$http_upgrade;
              proxy_set_header Connection "upgrade";
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
          }
      }

volumes:
  cert-data:
  nginx-dynamic:
  management-data:
