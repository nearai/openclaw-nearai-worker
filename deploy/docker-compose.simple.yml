# Simple Multi-Tenant OpenClaw Deployment (Direct Port Access)
# 
# This compose file sets up ONLY the Compose API.
# No Traefik - users access containers directly via IP:port.
# Only the Compose API has Docker socket access.
#
# Usage (from repo root):
#   1. Copy deploy/env.prod.example to deploy/.env.prod and configure
#   2. Build first: cd compose-api && docker build --build-arg CACHEBUST=$(date +%s) -t openclaw-compose-api:local .
#   3. docker compose -f deploy/docker-compose.simple.yml --env-file deploy/.env.prod up -d
#   4. Use the Compose API to create user containers

services:
  # ============================================
  # Compose API (Rust/Axum)
  # ============================================
  # This is the ONLY container with Docker socket access.
  # It creates/manages user containers programmatically.
  compose-api:
    # Build first from repo: cd compose-api && docker build --build-arg CACHEBUST=$(date +%s) -t openclaw-compose-api:local .
    image: openclaw-compose-api:local
    container_name: openclaw-compose-api
    restart: unless-stopped
    ports:
      - "${LISTEN_PORT:-47392}:${LISTEN_PORT:-47392}"
    volumes:
      # Docker socket - ONLY mounted here; worker compose projects run independently
      - /var/run/docker.sock:/var/run/docker.sock
      - management-data:/app/data
    environment:
      - RUST_LOG=info
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - OPENCLAW_HOST_ADDRESS=${OPENCLAW_HOST_ADDRESS:-localhost}
      - OPENCLAW_IMAGE=${OPENCLAW_IMAGE:-openclaw-nearai-worker:local}
      - COMPOSE_FILE=${COMPOSE_FILE:-/app/docker-compose.worker.yml}
      - LISTEN_ADDR=${LISTEN_ADDR:-0.0.0.0:47392}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${LISTEN_PORT:-47392}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  management-data:
