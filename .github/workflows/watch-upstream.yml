name: Watch Upstream Releases

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-ironclaw:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.cache.outputs.cache-hit != 'true' }}
      tag: ${{ steps.release.outputs.tag }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Get latest ironclaw release tag
        id: release
        run: |
          TAG=$(gh release view --repo nearai/ironclaw --json tagName -q '.tagName')
          # Strip any non-digit prefix: "ironclaw-v0.8.0" -> "0.8.0", "v0.9.0" -> "0.9.0"
          VERSION=$(echo "$TAG" | sed 's/^[^0-9]*//')
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Latest ironclaw release: $TAG (version $VERSION)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check if already seen
        id: cache
        uses: actions/cache@v4
        with:
          path: .ironclaw-release-marker
          key: ironclaw-release-${{ steps.release.outputs.tag }}

      - name: Save marker for cache
        if: steps.cache.outputs.cache-hit != 'true'
        run: echo "${{ steps.release.outputs.tag }}" > .ironclaw-release-marker

  check-openclaw:
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.cache.outputs.cache-hit != 'true' }}
      tag: ${{ steps.release.outputs.tag }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Get latest openclaw release tag
        id: release
        run: |
          TAG=$(gh release view --repo openclaw/openclaw --json tagName -q '.tagName')
          VERSION=${TAG#v}
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Latest openclaw release: $TAG (version $VERSION)"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check if already seen
        id: cache
        uses: actions/cache@v4
        with:
          path: .openclaw-release-marker
          key: openclaw-release-${{ steps.release.outputs.tag }}

      - name: Save marker for cache
        if: steps.cache.outputs.cache-hit != 'true'
        run: echo "${{ steps.release.outputs.tag }}" > .openclaw-release-marker

  version-bump-pr:
    needs: [check-ironclaw, check-openclaw]
    if: needs.check-ironclaw.outputs.new_release == 'true' || needs.check-openclaw.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Bump ironclaw version in Dockerfile
        if: needs.check-ironclaw.outputs.new_release == 'true'
        run: |
          VERSION="${{ needs.check-ironclaw.outputs.version }}"
          sed -i "s/^ARG IRONCLAW_VERSION=.*/ARG IRONCLAW_VERSION=${VERSION}/" ironclaw-worker/Dockerfile
          echo "Updated ironclaw-worker/Dockerfile: IRONCLAW_VERSION=${VERSION}"

      - name: Bump openclaw version in Dockerfile
        if: needs.check-openclaw.outputs.new_release == 'true'
        run: |
          VERSION="${{ needs.check-openclaw.outputs.version }}"
          sed -i "s/^ARG OPENCLAW_VERSION=.*/ARG OPENCLAW_VERSION=${VERSION}/" worker/Dockerfile
          echo "Updated worker/Dockerfile: OPENCLAW_VERSION=${VERSION}"

      - name: Validate changes were applied
        run: |
          if [[ "${{ needs.check-ironclaw.outputs.new_release }}" == "true" ]]; then
            if git diff --quiet ironclaw-worker/Dockerfile; then
              echo "ERROR: sed made no change to ironclaw-worker/Dockerfile" >&2
              exit 1
            fi
          fi
          if [[ "${{ needs.check-openclaw.outputs.new_release }}" == "true" ]]; then
            if git diff --quiet worker/Dockerfile; then
              echo "ERROR: sed made no change to worker/Dockerfile" >&2
              exit 1
            fi
          fi

      - name: Create pull request
        run: |
          NL=$'\n'
          COMPONENTS=""
          BODY="Automated version bump detected by watch-upstream.${NL}${NL}## Changes${NL}"

          if [[ "${{ needs.check-ironclaw.outputs.new_release }}" == "true" ]]; then
            COMPONENTS="ironclaw-${{ needs.check-ironclaw.outputs.version }}"
            BODY="${BODY}- **IronClaw**: \`${{ needs.check-ironclaw.outputs.version }}\` ([release](https://github.com/nearai/ironclaw/releases/tag/${{ needs.check-ironclaw.outputs.tag }}))${NL}"
          fi

          if [[ "${{ needs.check-openclaw.outputs.new_release }}" == "true" ]]; then
            [[ -n "$COMPONENTS" ]] && COMPONENTS="${COMPONENTS}-"
            COMPONENTS="${COMPONENTS}openclaw-${{ needs.check-openclaw.outputs.version }}"
            BODY="${BODY}- **OpenClaw**: \`${{ needs.check-openclaw.outputs.version }}\` ([release](https://github.com/openclaw/openclaw/releases/tag/${{ needs.check-openclaw.outputs.tag }}))${NL}"
          fi

          BRANCH="deps/bump-${COMPONENTS}"
          TITLE="Bump ${COMPONENTS}"

          # Skip if a PR already exists for this branch (handles cache expiry re-detection)
          EXISTING=$(gh pr list --head "$BRANCH" --state open --json number -q '.[0].number' || true)
          if [[ -n "$EXISTING" ]]; then
            echo "PR #${EXISTING} already exists for branch ${BRANCH}, skipping"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add ironclaw-worker/Dockerfile worker/Dockerfile
          git commit -m "$TITLE"
          git push --force-with-lease origin "$BRANCH"

          printf '%s' "$BODY" | gh pr create \
            --title "$TITLE" \
            --body-file - \
            --head "$BRANCH" \
            --base main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
